<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 基础元数据 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="3D模型共享平台 - 上传、浏览和下载3D模型">
    <meta name="keywords" content="3D模型,分享,下载,OBJ,FBX,GLTF">
    
    <!-- 页面标题 -->
    <title>3D模型共享平台 | Sharing Model</title>
    
    <!-- 样式表和脚本 -->
    <link rel="stylesheet" href="./pages/css/index.css">
    <!-- 引入jQuery库 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- 主应用容器 -->
    <div id="app">
        <!-- 头部区域 -->
        <header id="header">
            <div id="model">
                <h1>3D模型共享平台</h1>
                <div id="loginSuccessMessage" style="display: none;"></div>
            </div>
            
            <!-- 用户控制区域 -->
            <div class="user-section">
                <div id="adminIdDisplay"></div>
                <div id="user-controls">
                    <button id="loginButton" onclick="window.location.href='http://127.0.0.1:8000/login_url/'">登录</button>
                    <button id="logoutButton">退出登录</button>
                    <button id="profileButton" onclick="window.location.href='http://127.0.0.1:8000/profile/'">个人信息</button>
                    <button id="uploadButton" onclick="window.location.href='http://127.0.0.1:8000/model_upload_url/'">上传作品</button>
                    <button id="checkinButton">签到</button>
                </div>
            </div>
        </header>

        <!-- 搜索区域 -->
        <section id="search-container">
            <input type="text" id="search-input" placeholder="搜索模型（请输入作品编号，作品名，作者或者类型）" aria-label="搜索模型">
            <button id="search-button">搜索</button>
        </section>

        <!-- 3D视图区域 -->
        <main id="view">
            <!-- 模型格式选择按钮 -->
            <nav id="format-buttons">
                <button class="format-btn" data-format="obj">OBJ</button>
                <button class="format-btn" data-format="fbx">FBX</button>
                <button class="format-btn" data-format="gltf">GLTF</button>
                <button class="format-btn" data-format="glb">GLB</button>
                <button class="format-btn" data-format="mtl">MTL</button>
                <button class="format-btn" data-format="tga">TGA</button>
            </nav>
            
            <!-- 3D模型画布 -->
            <canvas id="model-canvas"></canvas>
        </main>
    </div>
    
    <!-- 主JavaScript文件 -->
    <script src="./pages/js/index.js" type="module" defer></script>
    
    <!-- 用户认证状态管理 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 为搜索框添加回车键事件监听
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('search-button').click();
            }
        });
        // 获取DOM元素
        const elements = {
            adminIdDisplay: document.getElementById('adminIdDisplay'),
            loginButton: document.getElementById('loginButton'),
            logoutButton: document.getElementById('logoutButton'),
            profileButton: document.getElementById('profileButton'),
            uploadButton: document.getElementById('uploadButton'),
            checkinButton: document.getElementById('checkinButton')
        };

        // 初始化按钮事件
        elements.loginButton.onclick = () => window.location.href='http://127.0.0.1:8000/login_url/';
        elements.profileButton.onclick = () => window.location.href='http://127.0.0.1:8000/profile/';
        elements.uploadButton.onclick = () => window.location.href='http://127.0.0.1:8000/model_upload_url/';

        /**
         * 检查用户登录状态
         */
        function checkAuthStatus() {
            try {
                const adminId = localStorage.getItem('admin_id');
                const userSerial = localStorage.getItem('user_serial');
                updateUI(adminId, userSerial);
            } catch (error) {
                console.error('获取用户凭证失败:', error);
                elements.adminIdDisplay.textContent = '欢迎，用户：获取失败';
                elements.loginButton.style.display = 'block';
            }
        }

        /**
         * 处理用户登出操作
         */
        elements.logoutButton.addEventListener('click', function() {
            try {
                // 清除所有用户相关数据
                localStorage.removeItem('user_serial');
                localStorage.removeItem('admin_id');
                localStorage.removeItem('lastCheckinDate');
                console.log('用户已登出，所有数据已清除');
                location.reload(); // 退出登录后刷新页面
            } catch (error) {
                console.error('清除用户凭证失败:', error);
                elements.adminIdDisplay.textContent = '欢迎，用户：获取失败';
            }
        });

        /**
         * 更新用户界面显示
         * @param {string} adminId - 管理员ID
         * @param {string} userSerial - 用户序列号
         */
        function updateUI(adminId, userSerial) {
            if (adminId) {
                elements.adminIdDisplay.textContent = `欢迎，用户编号：${userSerial}，用户名 ${adminId}`;
                elements.loginButton.style.display = 'none';
                elements.logoutButton.style.display = 'block';
                elements.profileButton.style.display = 'block';
                elements.uploadButton.style.display = 'block';
                elements.checkinButton.style.display = 'block';
                initCheckinButton();
            } else {
                elements.adminIdDisplay.textContent = '欢迎，用户：未登录';
                elements.loginButton.style.display = 'block';
                elements.checkinButton.style.display = 'none';
            }
        }

        /**
         * 更新签到按钮状态
         * @param {boolean} isSignedIn - 是否已签到
         */
        function updateCheckinButtonState(isSignedIn) {
            const button = elements.checkinButton;
            if (isSignedIn) {
                button.textContent = '已签到';
                button.disabled = true;
                button.style.opacity = '0.7';
            } else {
                button.textContent = '签到';
                button.disabled = false;
                button.style.opacity = '1';
            }
        }

        /**
         * 处理签到功能
         */
        elements.checkinButton.addEventListener('click', function() {
            const userSerial = localStorage.getItem('user_serial');
            if (!userSerial) {
                alert('请先登录后再签到');
                return;
            }
        
            // 禁用按钮防止重复点击
            this.disabled = true;
        
            $.ajax({
                url: 'http://127.0.0.1:8000/signin/',
                type: 'GET',
                data: { 
                    user_serial: userSerial
                },
                success: function(response) {
                    console.log('签到响应:', response);
                    if (response.message === '签到成功') {
                        alert(`签到成功！获得${response.integral}积分`);
                        updateCheckinButtonState(true);
                        localStorage.setItem('lastCheckinDate', new Date().toDateString());
                    } else {
                        alert(`签到失败：${response.message}今日已获得${response.integral}积分，请明天再来`);
                        updateCheckinButtonState(false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('签到请求失败:', error);
                    alert('签到请求失败，请稍后重试。错误详情：' + error);
                    updateCheckinButtonState(false);
                }
            });
        });
    
        /**
         * 初始化签到按钮状态
         */
        function initCheckinButton() {
            const userSerial = localStorage.getItem('user_serial');
            const today = new Date().toDateString();
        
            // 首先尝试从服务器获取签到状态
            $.ajax({
                url: 'http://127.0.0.1:8000/checkin_status/',
                type: 'GET',
                data: { user_serial: userSerial },
                success: function(response) {
                    console.log('签到状态响应:', response);
                    if (response.message === '已签到') {
                        updateCheckinButtonState(true);
                        localStorage.setItem('lastCheckinDate', today);
                    } else {
                        updateCheckinButtonState(false);
                        localStorage.removeItem('lastCheckinDate');
                    }
                },
                error: function() {
                    // 服务器请求失败，使用本地存储状态
                    const lastCheckinDate = localStorage.getItem('lastCheckinDate');
                    if (lastCheckinDate === today) {
                        updateCheckinButtonState(true);
                    } else {
                        updateCheckinButtonState(false);
                    }
                }
            });
        }

        // 初始化检查用户状态
        checkAuthStatus();
    });
    </script>
</body>
</html>
